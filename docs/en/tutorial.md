 
# Tutorial 

## Structure-from-Motion

运动恢复结构（SfM）从不同角度拍摄的图像中恢复场景的三维结构。
其输入是一组图像，输出是图像所观测到的场景的三维重建，这些结构一般由一系列是三维点表示也被成为点云。
通常，运动恢复结构系统可以分为两阶段：
匹配阶段通过特征匹配算法寻找图像的像素关联关系;
重建阶段通过二维的观测估计相机的位姿和三维结构。
基于单目图像的重建会缺失真实的尺度，因此XRSfM额外提供了估计尺度功能。
估计尺度功能依赖于场景中预先放置的人工标志物。
具有真实尺度的三维结构能够很好的支持面向AR的定位应用。


### 1.Feature extraction and matching
Input:
images
retrivel_results

Output:
ftr.bin
fp.bin

Run matching stage with the following command line

```
./bin/run_matching images_path retrival_path matching_type output_path
```

"retrival_path" indicates the path of the retrieval file, which stores the results of image retrieval.
Currently, the image retrieval function is supported in XRLoc.
You can generate the file directly by xrloc or use other retrieval methods .

"matching_type" indicates the matching strategy.
Currently, XRSfM supports sequential matching("sequential"), image-retrieval-based matching("retrival"), covisibility-based matching("covisibility").
The covisibility-based matching is a implementation of "Efficient Covisibility-Based Image Matching for Large-Scale SfM".



### 2.Scene reconstruction
Input:
fp.bin
ftr.bin
camera.txt

Output:
camera.bin
images.bin
points.bin

Run sequential data with the following command line
```
./bin/sequential_reconstruction bin_path images_path camera_path output_path init_id1 init_id2
```

"bin_path" is a folder path containing binaries of features and matching results which can be generated by Step 1. 

"camera_path" is the path of camera.txt. camera.txt stores the infomation of camera internal parameters.

"init_id1" and "init_id2" indicates two frames for the initialization of SfM.
In general, these two frames can be set to 0 and 5.

The format of output binary files is is consistent with COLMAP, you can use colmap gui to view the reconstruction result.

### 3.Estimate scale with apriltag
Input:
images
camera.bin
images.bin
points.bin

Output:
real_sized_camera.bin
real_sized_images.bin
real_sized_points.bin

Run sequential data with the following command line
```
./bin/tag_refine images_dir map_dir
```

"map_dir" store the map binary files (camera.bin, images.bin, points.bin).

This step aims to recover the true scale of the reconstruction result.
First, ensure that the input reconstruction results are correct, otherwise the whole process can not run normally.
The program will extract the apriltag from images to calculate the scale, and ensure that the apriltag of each ID is unique in the scene.

### Run example

Download test data from url and put the test data in the folder 'test data'.
Run sequential data with the following command line 
```
cd xrsfm
./bin/test_r
```

### Run your data

数据采集
我们推荐使用采集工具拍摄图像，它会同时获取一个准确的相机内参。
用户也可以使用其他来源的图像，但鉴于当前xrsfm并不支持相机自标定，用户需要给出相机内参，这可以由标定得到。
更多的相机模型支持和相机自标定功能将在后续的版本中支持。

数据准备
除了上述的图像数据和相机内参外，还需要准备图像的检索结果，这部分功能目前被封装在xrloc中，详细参见URL

运行重建

images_path 
retrival_path
camera_path
results_path
refined_results_path

./bin/run_matching ${images_path}$ ${retrival_path}$ sequential ${results_path}$
./bin/sequential_reconstruction ${results_path}$ ${images_path}$ ${camera_path}$ ${results_path}$
./bin/tag_refine ${images_path}$ ${results_path}$ ${refined_results_path}$